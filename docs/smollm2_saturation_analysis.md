# SmolLM2-135M Saturation Analysis

## 概要

SmolLM2-135M（30層）の各レイヤーにおけるcos_sim（入力と出力のコサイン類似度）分布を分析し、CASCADE Early Exit設計への示唆を得る。

**分析条件**:
- モデル: SmolLM2-135M-Instruct
- データ: Alpaca (500サンプル)
- シーケンス長: 128
- トークン数: 43,008

## レイヤー別cos_sim統計

| Layer | mean | std | min | p10 | p50 | p90 | max |
|-------|------|-----|-----|-----|-----|-----|-----|
| 1 | 0.0056 | 0.0846 | -0.2208 | -0.1107 | 0.0231 | 0.1008 | 0.2186 |
| 2 | 0.8203 | 0.0947 | 0.4541 | 0.6909 | 0.8330 | 0.9292 | 0.9678 |
| 3 | 0.9648 | 0.0224 | 0.7500 | 0.9380 | 0.9722 | 0.9819 | 0.9927 |
| 4 | 0.9731 | 0.0228 | 0.7275 | 0.9546 | 0.9795 | 0.9888 | 1.0010 |
| 5 | 0.9683 | 0.0210 | 0.7773 | 0.9453 | 0.9731 | 0.9854 | 1.0010 |
| 6 | 0.9653 | 0.0189 | 0.8047 | 0.9424 | 0.9692 | 0.9824 | 1.0010 |
| 7 | 0.9648 | 0.0185 | 0.8008 | 0.9429 | 0.9683 | 0.9819 | 1.0010 |
| 8 | 0.9644 | 0.0193 | 0.7866 | 0.9380 | 0.9678 | 0.9829 | 1.0010 |
| 9 | 0.9546 | 0.0216 | 0.8081 | 0.9243 | 0.9585 | 0.9761 | 1.0000 |
| 10 | 0.9668 | 0.0192 | 0.5986 | 0.9478 | 0.9707 | 0.9829 | 0.9985 |
| 11 | 0.9595 | 0.0544 | -0.1787 | 0.9409 | 0.9717 | 0.9834 | 0.9937 |
| 12 | 0.9614 | 0.0690 | -0.4006 | 0.9458 | 0.9712 | 0.9824 | 0.9922 |
| 13 | 0.9746 | 0.0115 | 0.8164 | 0.9609 | 0.9771 | 0.9858 | 1.0010 |
| 14 | 0.9756 | 0.0097 | 0.8428 | 0.9639 | 0.9771 | 0.9854 | 1.0010 |
| 15 | 0.9761 | 0.0119 | 0.8530 | 0.9600 | 0.9785 | 0.9883 | 1.0010 |
| 16 | 0.9707 | 0.0109 | 0.7534 | 0.9561 | 0.9731 | 0.9819 | 1.0010 |
| 17 | 0.9707 | 0.0096 | 0.8882 | 0.9585 | 0.9717 | 0.9819 | 1.0010 |
| 18 | 0.9751 | 0.0105 | 0.8901 | 0.9604 | 0.9766 | 0.9868 | 1.0010 |
| 19 | 0.9614 | 0.0164 | 0.8496 | 0.9404 | 0.9648 | 0.9780 | 1.0010 |
| 20 | 0.9590 | 0.0153 | 0.7749 | 0.9399 | 0.9614 | 0.9751 | 1.0010 |
| 21 | 0.9429 | 0.0294 | 0.7422 | 0.9019 | 0.9497 | 0.9741 | 1.0010 |
| 22 | 0.9565 | 0.0192 | 0.8101 | 0.9336 | 0.9580 | 0.9795 | 1.0010 |
| 23 | 0.9536 | 0.0195 | 0.7861 | 0.9297 | 0.9565 | 0.9736 | 1.0010 |
| 24 | 0.9458 | 0.0278 | 0.5576 | 0.9102 | 0.9526 | 0.9712 | 1.0010 |
| 25 | 0.8408 | 0.0417 | 0.4963 | 0.7886 | 0.8457 | 0.8838 | 1.0010 |
| 26 | 0.9741 | 0.0199 | 0.7393 | 0.9531 | 0.9790 | 0.9902 | 1.0010 |
| 27 | 0.9717 | 0.0185 | 0.7515 | 0.9517 | 0.9761 | 0.9873 | 1.0010 |
| 28 | 0.9517 | 0.0173 | 0.8027 | 0.9316 | 0.9546 | 0.9688 | 1.0000 |
| 29 | 0.9482 | 0.0198 | -0.1910 | 0.9312 | 0.9517 | 0.9634 | 0.9922 |
| 30 | 0.1309 | 0.1906 | -0.5742 | -0.1032 | 0.1207 | 0.3782 | 0.7773 |

## レイヤー構造の可視化

```
Layer  1: 0.0056 ▏                                              (入力変換)
Layer  2: 0.8203 █████████████████████████████████████████
Layer  3: 0.9648 ████████████████████████████████████████████████
Layer  4: 0.9731 ████████████████████████████████████████████████
Layer  5: 0.9683 ████████████████████████████████████████████████
Layer  6: 0.9653 ████████████████████████████████████████████████
Layer  7: 0.9648 ████████████████████████████████████████████████
Layer  8: 0.9644 ████████████████████████████████████████████████
Layer  9: 0.9546 ███████████████████████████████████████████████
Layer 10: 0.9668 ████████████████████████████████████████████████
Layer 11: 0.9595 ███████████████████████████████████████████████
Layer 12: 0.9614 ████████████████████████████████████████████████
Layer 13: 0.9746 ████████████████████████████████████████████████
Layer 14: 0.9756 ████████████████████████████████████████████████
Layer 15: 0.9761 ████████████████████████████████████████████████ (最高)
Layer 16: 0.9707 ████████████████████████████████████████████████
Layer 17: 0.9707 ████████████████████████████████████████████████
Layer 18: 0.9751 ████████████████████████████████████████████████
Layer 19: 0.9614 ████████████████████████████████████████████████
Layer 20: 0.9590 ███████████████████████████████████████████████
Layer 21: 0.9429 ███████████████████████████████████████████████
Layer 22: 0.9565 ███████████████████████████████████████████████
Layer 23: 0.9536 ███████████████████████████████████████████████
Layer 24: 0.9458 ███████████████████████████████████████████████
Layer 25: 0.8408 ██████████████████████████████████████████      (中間特異点)
Layer 26: 0.9741 ████████████████████████████████████████████████
Layer 27: 0.9717 ████████████████████████████████████████████████
Layer 28: 0.9517 ███████████████████████████████████████████████
Layer 29: 0.9482 ███████████████████████████████████████████████
Layer 30: 0.1309 ██████                                          (出力変換)
```

## 重要な発見

### 1. 特殊なレイヤー

| レイヤー | cos_sim | 特徴 |
|----------|---------|------|
| **Layer 1** | 0.0056 | embedding→最初のレイヤーで劇的に変化 |
| **Layer 25** | 0.8408 | 中間で最もactive（重要な処理をしている可能性） |
| **Layer 30** | 0.1309 | 最終出力への大きな変換 |

### 2. 安定期（Layer 3-24, 26-29）

- cos_sim > 0.94
- 入力と出力がほぼ同じ方向
- 情報を徐々に精緻化

### 3. 異常値の存在

| Layer | 負の値の割合 | <0.5の割合 |
|-------|-------------|-----------|
| 1 | 37.61% | 100.00% |
| 11 | 0.01% | 0.22% |
| 12 | 0.08% | 0.78% |
| 29 | 0.01% | 0.01% |
| 30 | 24.30% | 96.08% |

## CASCADE設計への示唆

### 問題点

**Layer 30（最終レイヤー）をexit判定に使用するのは不適切**:
- cos_sim mean = 0.13（極端に低い）
- 全トークンが大きく変化する
- hard/easyの区別がつかない

### 推奨アプローチ

1. **Layer 29基準でのexit判定**
   - cos_sim分布が安定（mean=0.95, std=0.02）
   - hard tokenの識別が可能

2. **推奨threshold値（Layer 29基準）**

| Hard Ratio | Threshold | 用途 |
|------------|-----------|------|
| 30% | 0.9453 | 積極的なearly exit |
| 50% | 0.9517 | バランス型 |
| 70% | 0.9570 | 保守的 |

### 実装への反映

現在のCASCADEは`hidden_history[-2]`（最後から2番目=Layer 29入力）と`hidden_history[-1]`（Layer 29出力=Layer 30入力）を比較している。

これは実質的にLayer 30の変化を見ているため、**Layer 29のexit判定（hidden_history[-3]とhidden_history[-2]の比較）に変更**することを推奨。

```python
# 現在の実装（cascade_dataset.py）
h_in = hidden_history[-2]  # Layer 29入力
h_out = hidden_history[-1]  # Layer 29出力 = Layer 30入力

# 推奨変更
h_in = hidden_history[-3]  # Layer 28出力 = Layer 29入力
h_out = hidden_history[-2]  # Layer 29出力
```

## 実験コマンド

```bash
# Layer 29基準でhard_ratio=0.5の場合
python experiments/smollm2_cascade.py --threshold 0.9517 --hard-ratio 0.5

# より多くをearly exitさせたい場合（hard_ratio=0.3）
python experiments/smollm2_cascade.py --threshold 0.9453 --hard-ratio 0.3
```

## 今後の調査項目

1. Layer 25が特異的に変化する理由の調査
2. 異なるデータセット（WikiText等）での比較
3. SmolLM2-360M, 1.7Bでの同様の分析
4. exit判定レイヤーの最適化実験

## 参考

- 分析スクリプト: `experiments/collect_cos_sim_data.py`
- データファイル: `cos_sim_data.npz`
- 分析日: 2024年
